<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>ルート地図</title>
<style>
body {
  margin: 0;
}
#map {
  width: 100%;
  position: absolute;
  top: 0;
  bottom: 0;
}
</style>
<script src="https://www.bing.com/api/maps/mapcontrol?callback=GetMap&key=ApSrHyswQlSkhiwqypJU_HidSkz0pWKYg7mpCYwpR1oja2ai3CHxJOHpa2LB5NNh" async defer></script>
<script>
const param = {
  lon: 138.723460, lat: 35.931374, zoom: 13,
  url: 'https://anineco.github.io/gpx2geojson/example/routemap.geojson'
};
location.search.slice(1).split('&').forEach(function (ma) {
  const s = ma.split('=');
  if (s[0] === 'url') {
    param[s[0]] = decodeURIComponent(s[1]);
  } else if (s[0] in param) {
    param[s[0]] = Number(s[1]);
  }
});

function GetMap() {
  const map = new Microsoft.Maps.Map('#map', {
    center: new Microsoft.Maps.Location(param.lat, param.lon),
    zoom: param.zoom,
    navigationBarMode: Microsoft.Maps.NavigationBarMode.compact
  });
  const track = new Microsoft.Maps.Layer();
  map.layers.insert(track);
  Microsoft.Maps.loadModule('Microsoft.Maps.GeoJson', function () {
    Microsoft.Maps.GeoJson.readFromUrl(param.url, function (shapes) {
      shapes.forEach(function (shape) {
        if (shape instanceof Microsoft.Maps.Pushpin) {
          const a = shape.metadata._iconAnchor;
          shape.setOptions({
            icon: shape.metadata._iconUrl,
            anchor: new Microsoft.Maps.Point(a[0], a[1]),
            title: shape.metadata.name
          });
        } else if (shape instanceof Microsoft.Maps.Polyline) {
          const c = shape.metadata._color.match(/^#(..)(..)(..)$/).slice(1).map(function (h) { // NOTE: '=>' does not work in IE11
            return parseInt(h, 16);
          });
          c[3] = Math.round(255 * shape.metadata._opacity);
          shape.setOptions({
            strokeThickness: shape.metadata._weight,
            strokeColor: new Microsoft.Maps.Color(c[3], c[0], c[1], c[2]),
            strokeDashArray: shape.metadata._dashArray.split(',').map(function (v) { // NOTE: '=>' does not work in IE11
              return v / shape.metadata._weight;
            })
          });
        }
      });
      track.add(shapes);
    });
  });

  const popup = new Microsoft.Maps.Infobox(map.getCenter(), {
    visible: false
  });
  popup.setMap(map);
  Microsoft.Maps.Events.addHandler(track, 'click', function (event) {
    const shape = event.target;
    if (shape instanceof Microsoft.Maps.Pushpin) {
      const keys = Object.keys(shape.metadata).filter(function (key) { // NOTE: '=>' does not work in IE11
        return key !== 'name' && key.charAt(0) !== '_';
      });
      let html = undefined;
      if (keys.length > 0) {
        html = '<table><tbody><tr><td>' + keys.map(function (key) { // NOTE: '=>' does not work in IE11
          return key + '</td><td>' + shape.metadata[key];
        }).join('</td></tr><tr><td>') + '</td></tr></tbody></table>';
      }
      popup._options.description = undefined; // NOTE: initialize 'description'
      popup.setOptions({
        location: shape.getLocation(),
        title: shape.metadata.name,
        description: html,
        visible: true
      });
    }
  });
}
</script>
</head>
<body>
<div id="map"></div>
</body>
</html>
